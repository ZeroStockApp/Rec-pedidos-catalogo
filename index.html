<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recepción de Pedidos</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    html{color-scheme: light;}
    :root{
      --primary:#136f63; --ink:#111827; --bg:#f7f7f8; --card:#ffffff; --ring:#d1d5db; --muted:#6b7280; --radius:14px;
      color-scheme: light;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial; background:var(--bg); color:var(--ink); margin:0;}
    .container{max-width:980px; margin:32px auto; padding:0 16px}
    h1{font-size:clamp(22px,3vw,28px); margin:0 0 6px}
    .sub{color:#374151; margin:0 0 18px}
    .card{background:var(--card); border:1px solid var(--ring); border-radius:var(--radius); box-shadow:0 6px 24px rgba(0,0,0,.06)}
    .form{padding:18px}
    .row{display:grid; gap:14px; grid-template-columns:repeat(12,1fr)}
    .col-3{grid-column:span 3}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    label{display:block; font-size:13px; color:var(--muted); margin:2px 0 6px}
    input[type=text], input[type=number], select{width:100%; padding:10px 12px; border:1px solid var(--ring); border-radius:10px; background:#fff; font-size:14px}
    select{background:#fff; color:#111827;}
    select{color-scheme: light; -webkit-text-fill-color:#111827;}
    .actions{display:flex; gap:10px; flex-wrap:wrap; padding:16px; border-top:1px solid var(--ring); background:linear-gradient(#fff,#fbfbfb)}
    button{appearance:none; border:0; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; font-size:14px}
    .primary{background:var(--primary); color:#fff}
    .ghost{background:#1e8f7f; color:#fff;}
    .ghost:hover{background:#136f63;}
    .danger{background:#fee2e2; color:#7f1d1d}

    .table-card{margin-top:16px; border-radius:14px; overflow:hidden; border:1px solid #000;}
    table{border-collapse:collapse; width:100%; font-size:14px;}
    th,td{padding:6px 8px; overflow:hidden; text-overflow:ellipsis;}
    table, thead th, tbody td {border:1px solid #000;}
    thead th{background:#136f63; color:#fff; text-align:center;}
    tbody td.num{text-align:center}

    #btnPdf{background:#DB2777;color:#fff}
    #btnPdf:hover{background:#BE185D}

    .btn-edit{background:#e0f2fe; color:#0369a1; border-radius:6px; padding:4px 8px; margin:0 3px}
    .btn-del{background:#fee2e2; color:#b91c1c; border-radius:6px; padding:4px 8px; margin:0 3px}
    td.actions-cell{display:flex; justify-content:center; align-items:center;}
    td.actions-cell button{flex:1; text-align:center;}
    th:last-child, td.actions-cell{width:150px;}

    /* Ajuste final de la tabla en pantalla */
    #tbl tbody tr { height: auto !important; }
    #tbl tbody td { padding: 2px 6px !important; line-height: 1.1 !important; }
    #tbl tbody td.actions-cell { padding-top: 0 !important; padding-bottom: 0 !important; }
    #tbl tbody td.actions-cell .btn-edit,
    #tbl tbody td.actions-cell .btn-del { padding: 2px 6px !important; font-size: 12px !important; }

    /* Filas alternadas tipo Excel (pantalla) */
    #tbl tbody tr:nth-child(odd) { background-color: #f3f9f7 !important; }
    #tbl tbody tr:nth-child(even) { background-color: #ffffff !important; }

    /* Zebra en pantalla */
    .table-card table tbody tr:nth-child(odd) { background-color: #f3f9f7; }
    .table-card table tbody tr:nth-child(even) { background-color: #ffffff; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Recepción de Pedidos</h1>
    <p class="sub"><span id="gen"></span> | <span id="roleLabel">Recibido por</span>: <b id="recibidoTop">(selecciona abajo)</b></p>

    <section class="card form">
      <h2 style="margin:0 0 10px; font-size:18px">Nuevo pedido</h2>

      <!-- Selector de modo (no modifica estilos existentes) -->
      <div class="row">
        <div class="col-12">
          <label>Tipo de registro</label>
          <div style="display:flex;align-items:center;gap:14px">
            <label><input id="modeRecep" type="radio" name="mode" value="Recepción" checked> Recepción</label>
            <label><input id="modeEnvio" type="radio" name="mode" value="Envío"> Envío</label>
          </div>
        </div>
      </div>

      <!-- En modo Envío, se elige una sola vez la distribuidora -->
      <div id="envioBlock" class="row" style="display:none;">
        <div class="col-6">
          <label for="distEnvio">Distribuidora (modo Envío — se usa para todo)</label>
          <select id="distEnvio"></select>
        </div>
        <div class="col-3">
          <label for="fechaDesde">Desde</label>
          <input id="fechaDesde" type="date" />
        </div>
        <div class="col-3">
          <label for="fechaHasta">Hasta</label>
          <input id="fechaHasta" type="date" />
        </div>
        <div class="col-12" style="display:flex;gap:10px;align-items:flex-end;">
          <button class="primary" type="button" id="btnCargar" style="margin-top:6px;">Cargar pedidos pendientes</button>
          <span id="envioStatus" style="color:#6b7280;font-size:13px;"></span>
        </div>
      </div>

      <div class="row">
        <div class="col-3">
          <label for="numero">Nº pedido</label>
          <input id="numero" type="text" placeholder="Ej: P00001" />
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <label for="dist">Distribuidora</label>
          <select id="dist"></select>
        </div>
        <div class="col-6">
          <label for="vend">Vendedora / Consultora</label>
          <input id="vend" type="text" placeholder="Escribe el nombre completo" />
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <label for="rec">Recibido por</label>
          <select id="rec"></select>
        </div>
        <div class="col-3">
          <label for="paq">Nº de paquetes</label>
          <input id="paq" type="number" min="1" value="1" />
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="btnSave">Guardar pedido</button>
        <button class="ghost" id="btnPdf" type="button">Descargar PDF</button>
        <button class="danger" id="btnClear">Borrar todo</button>
      </div>
    </section>

    <div class="card table-card">
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>Nº<br>pedido</th>
            <th>Distribuidora</th>
            <th>Vendedora</th>
            <th>Nº<br>paq</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
// Distribuidoras (una por línea, comillas y comas correctas)
const DIST = [
  "Ana Elizabeth Krause Seron",
  "Carla Valentina Gallardo Miranda",
  "Claudia Edith Perez Cobo",
  "Darly Solange Cartes Placencia",
  "Denisse Paulina Castro Almonacid",
  "Elizabeth Nathalie Torrez Pena",
  "Francheska Gisley Vasquez Perez",
  "Fredna Odette Cardenas Yanez",
  "Jeniffer Alejandra Gallardo Palma",
  "Katherine Naara Sanhueza Cid",
  "Madeleine Escobar Riquelme",
  "Maria Jose Urrea Leal",
  "Mixsi Urania Carrasco Garnica",
  "Monica Andrea Oliva Quiroga",
  "Nayareth Yetsennia Sanhueza Valdez",
  "Paola Lorena Contreras Alarcon",
  "Rocio Pilar Guerrero Barria",
  "Patricia Alejandra Marcos Villalobos",
  "Solange Stefani Soto Huala",
  "Valentina Beatriz Cancino Maldonado",
  "Viviana Erika Soto Oliva",
  "Yanira Constanza Espinoza Benavides"
];

// Recibido por (orden que usabas)
const REC = [
  "Harumi Araujo",
  "Mireya Venegas",
  "Daniel Parada",
  "Claudia Cuero",
  "Maria Alvarez",
  "Juan Fernandez",
];

// ===============================
// ✅ Conexión a Google Apps Script
// ===============================
// URL de tu Web App (Apps Script)
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxuQsp71wM3ZMq89B5KDlM4jZlPYQaz24oqPGA6s9IC_3VWzFcCZ5ZvA6kGSx889vK00g/exec";

// Tag de version para saber si GitHub esta sirviendo el HTML nuevo
const BUILD_TAG = "save-addOne-numPedido-v5";

// Accion fija para guardar (segun tu backend)
const SAVE_ACTION = "addOne";

// Accion propuesta para consultar pendientes (se implementa en Apps Script)
const PENDING_ACTION = "getPending";

async function fetchJsonSafe(res){
  const text = await res.text();
  try { return { ok: res.ok, json: JSON.parse(text), text }; }
  catch { return { ok: res.ok, json: null, text }; }
}

function looksLikeSuccess(payload){
  if(!payload) return false;
  if(typeof payload === 'string'){
    const t = payload.trim().toLowerCase();
    return t === 'ok' || t === 'success' || t.includes('guardado') || t.includes('saved');
  }
  if(typeof payload === 'object'){
    if(payload.ok === true || payload.success === true) return true;
    if(typeof payload.status === 'string' && payload.status.toLowerCase() === 'ok') return true;
    if(typeof payload.result === 'string' && payload.result.toLowerCase() === 'ok') return true;
  }
  return false;
}

function extractId(payload){
  if(!payload || typeof payload !== 'object') return '';
  return String(payload.id || payload.rowId || payload.insertId || payload.uuid || '');
}

async function postToBackend(action, data){
  const qs = new URLSearchParams();
  qs.set('action', action);
  Object.entries(data).forEach(([k,v]) => qs.set(k, String(v ?? '')));

  const url = `${APPS_SCRIPT_URL}?${qs.toString()}`;

  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
    body: JSON.stringify(data)
  });

  const out = await fetchJsonSafe(res);
  const payload = out.json ?? out.text;
  if(looksLikeSuccess(payload)) return { ok:true, payload };
  return { ok:false, payload };
}

async function getFromBackend(action, params){
  const qs = new URLSearchParams();
  qs.set('action', action);
  Object.entries(params || {}).forEach(([k,v]) => qs.set(k, String(v ?? '')));

  const url = `${APPS_SCRIPT_URL}?${qs.toString()}`;
  const res = await fetch(url, { method: 'GET' });
  const out = await fetchJsonSafe(res);
  return out.json ?? out.text;
}

async function savePedidoToSheet(data){
  return await postToBackend(SAVE_ACTION, data);
}

  // ===== Referencias UI =====
  const els={
    gen:document.getElementById('gen'),
    recibidoTop:document.getElementById('recibidoTop'),
    numero:document.getElementById('numero'),
    dist:document.getElementById('dist'),
    vend:document.getElementById('vend'),
    rec:document.getElementById('rec'),
    paq:document.getElementById('paq'),
    tbody:document.querySelector('#tbl tbody'),
    btnSave:document.getElementById('btnSave'),
    btnPdf:document.getElementById('btnPdf'),
    btnClear:document.getElementById('btnClear')
  };
  const ui={
    roleLabel:document.getElementById('roleLabel'),
    modeRecep:document.getElementById('modeRecep'),
    modeEnvio:document.getElementById('modeEnvio'),
    envioBlock:document.getElementById('envioBlock'),
    distEnvio:document.getElementById('distEnvio'),
    fechaDesde:document.getElementById('fechaDesde'),
    fechaHasta:document.getElementById('fechaHasta'),
    btnCargar:document.getElementById('btnCargar'),
    envioStatus:document.getElementById('envioStatus')
  };

  let currentMode='Recepción';
  let rows=[]; let editIndex=-1;

  function init(){
    els.gen.textContent=`Generado: ${new Date().toLocaleString('es-CL')}`;
    loadSelect(els.dist,DIST); loadSelect(els.rec,REC); loadSelect(ui.distEnvio,DIST);
    setMode('Recepción');
  }
  function loadSelect(sel,list){sel.innerHTML='<option value="" disabled selected>Selecciona...</option>'+list.map(x=>`<option>${x}</option>`).join('');}
  function shortDist(full){const p=full.trim().split(/\s+/); if(p.length>=4)return `${p[0]} ${p[2]}`; if(p.length===3)return `${p[0]} ${p[1]}`; if(p.length===2)return `${p[0]} ${p[1]}`; return full;}

  // ===== Selector de modo =====
  function clearTableAndForm(){ rows=[]; paint(); els.numero.value=''; els.vend.value=''; els.paq.value=1; els.dist.selectedIndex=0; }
  function setMode(mode){
    currentMode=mode;
    if(ui.roleLabel) ui.roleLabel.textContent = (mode==='Envío') ? 'Enviado por' : 'Recibido por';

    if(mode==='Envío'){
      ui.envioBlock.style.display='grid';
      els.dist.disabled=true;
      els.dist.value = ui.distEnvio.value || '';
    }else{
      ui.envioBlock.style.display='none';
      els.dist.disabled=false;
      els.dist.selectedIndex=0;
    }
    clearTableAndForm();
  }
  ui.modeRecep.addEventListener('change',()=>setMode('Recepción'));
  ui.modeEnvio.addEventListener('change',()=>setMode('Envío'));
  ui.distEnvio.addEventListener('change',()=>{ if(currentMode==='Envío'){ els.dist.value=ui.distEnvio.value||''; }});

  // ===== Envío: cargar pendientes =====
  function setEnvioStatus(msg){ if(ui.envioStatus) ui.envioStatus.textContent = msg || ''; }

  function normalizePendingResponse(raw){
    if(!raw) return [];
    // Formatos tolerados:
    // 1) [ { ... } ]
    // 2) { data: [ ... ] }
    // 3) { rows: [ ... ] }
    // 4) { pending: [ ... ] }
    if(Array.isArray(raw)) return raw;
    if(typeof raw === 'object'){
      if(Array.isArray(raw.data)) return raw.data;
      if(Array.isArray(raw.rows)) return raw.rows;
      if(Array.isArray(raw.pending)) return raw.pending;
    }
    return [];
  }

  function mapPendingItemToRow(item, selectedDist){
    const it = item || {};
    const id = String(it.id || it.rowId || it.uuid || it.ID || '');
    const pedido = String(it.pedido || it.numPedido || it.numero || it.n || it.PEDIDO || '').trim();
    const distribuidora = String(it.distribuidora || it.d || it.DISTRIBUIDORA || selectedDist || '').trim();
    const vendedora = String(it.vendedora || it.v || it.VENDEDORA || '').trim();
    const paquetes = Number(it.paquetes ?? it.q ?? it.PAQUETES ?? 0) || 0;
    return { id, n: pedido, d: distribuidora, v: vendedora, q: paquetes };
  }

  async function cargarPendientesEnvio(){
    if(currentMode!=='Envío') return;
    const dist = (ui.distEnvio && ui.distEnvio.value) ? ui.distEnvio.value : '';
    if(!dist){ alert('Selecciona una distribuidora (modo Envío).'); return; }

    const desde = ui.fechaDesde ? (ui.fechaDesde.value || '') : '';
    const hasta = ui.fechaHasta ? (ui.fechaHasta.value || '') : '';
    if(!desde || !hasta){ alert('Selecciona el rango de fechas (Desde y Hasta).'); return; }

    setEnvioStatus('Cargando pendientes…');
    ui.btnCargar.disabled = true;

    try{
      const raw = await getFromBackend(PENDING_ACTION, { distribuidora: dist, desde, hasta });
      const list = normalizePendingResponse(raw);

      if(!Array.isArray(list) || list.length===0){
        setEnvioStatus('No hay pedidos pendientes en ese rango.');
        rows = [];
        paint();
        return;
      }

      rows = list
        .map(x => mapPendingItemToRow(x, dist))
        .filter(r => r.n);

      paint();
      setEnvioStatus(`Listo: ${rows.length} pedido(s) cargado(s).`);

    }catch(e){
      console.error('[cargarPendientesEnvio]', e);
      setEnvioStatus('No se pudo cargar. Falta implementar doGet/action en Apps Script.');
      alert('No se pudo cargar pendientes desde el backend.\n\nSiguiente paso: implementar doGet (action=getPending) en Apps Script.');
    }finally{
      ui.btnCargar.disabled = false;
    }
  }

  if(ui.btnCargar){
    ui.btnCargar.addEventListener('click', cargarPendientesEnvio);
  }

  // ===== CRUD =====
  async function save(){
    const distValue=(currentMode==='Envío')?ui.distEnvio.value:els.dist.value;
    if(!els.numero.value||!distValue||!els.vend.value||!els.rec.value||!els.paq.value){alert('Completa todos los campos');return;}

    const dataBase={
      id: (editIndex>-1 && rows[editIndex] && rows[editIndex].id) ? rows[editIndex].id : '',
      n:els.numero.value.trim(),
      d:distValue,
      v:els.vend.value.trim(),
      q:Number(els.paq.value)
    };

    const payload={
      id: dataBase.id,
      fecha: new Date().toISOString(),
      pedido: dataBase.n,
      distribuidora: dataBase.d,
      vendedora: dataBase.v,
      paquetes: dataBase.q,
      recibidoPor: els.rec.value,
      enviado: 'NO',
      modo: currentMode
    };

    const payloadToSend = { action: SAVE_ACTION, numPedido: payload.pedido, pedido: payload.pedido, ...payload };

    els.btnSave.disabled = true;
    els.btnSave.textContent = 'Guardando…';

    console.log('[Guardar pedido]', BUILD_TAG, payloadToSend);
    console.log('[Guardar pedido] URL preview:', `${APPS_SCRIPT_URL}?action=${encodeURIComponent(SAVE_ACTION)}&numPedido=${encodeURIComponent(payloadToSend.numPedido ?? '')}`);

    const result = await savePedidoToSheet(payloadToSend);

    els.btnSave.disabled = false;
    els.btnSave.textContent = 'Guardar pedido';

    if(!result || !result.ok){
      const msg = (result && result.payload) ? (typeof result.payload === 'string' ? result.payload : JSON.stringify(result.payload)) : 'Error desconocido';
      const urlPreview = `${APPS_SCRIPT_URL}?action=${encodeURIComponent(SAVE_ACTION)}&numPedido=${encodeURIComponent(payloadToSend.numPedido ?? '')}`;
      alert(`No se pudo guardar en Google Sheets.\n\nDetalle:\n${msg}\n\nBUILD_TAG: ${BUILD_TAG}\n\nPayload enviado (resumen):\nnumPedido=${payloadToSend.numPedido}\npedido=${payloadToSend.pedido}\n\nURL preview (deberia incluir numPedido):\n${urlPreview}`);
      return;
    }

    // ✅ Intentamos capturar el id retornado por el backend para que markSent funcione
    const returnedId = extractId(result.payload);
    const data = { ...dataBase, id: dataBase.id || returnedId };

    if(editIndex>-1){ rows[editIndex]=data; editIndex=-1; } else { rows.push(data); }
    els.recibidoTop.textContent=els.rec.value;
    els.numero.value=''; els.vend.value=''; els.paq.value=1; if(currentMode==='Recepción'){ els.dist.selectedIndex=0; }
    paint();
    els.numero.focus();
  }

  function paint(){
    els.tbody.innerHTML=rows.map((r,i)=>`<tr>
      <td class="num">${i+1}</td>
      <td>${r.n}</td>
      <td>${shortDist(r.d)}</td>
      <td>${r.v}</td>
      <td class="num">${r.q}</td>
      <td class="actions-cell">
        <button class="btn-edit" onclick="editRow(${i})">Editar</button>
        <button class="btn-del" onclick="delRow(${i})">Eliminar</button>
      </td>
    </tr>`).join('');
  }

  window.editRow=function(i){ const r=rows[i]; els.numero.value=r.n; els.dist.value=r.d; els.vend.value=r.v; els.paq.value=r.q; editIndex=i; if(currentMode==='Envío'){ ui.distEnvio.value=r.d; } };
  window.delRow=function(i){ if(confirm('¿Eliminar este pedido?')){ rows.splice(i,1); paint(); } };

 function toPDF(){
  try{
    if(rows.length===0){ alert('No hay registros'); return; }

    // Bloquear PDF si no se eligió quién entrega
    if(!els.rec.value){
      alert((currentMode==='Envío') ? 'Selecciona "Enviado por" antes de descargar el PDF.' : 'Selecciona "Recibido por" antes de descargar el PDF.');
      return;
    }

    // Verificar librerías PDF
    const jsPDFCtor = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : (window.jsPDF || null);
    if(!jsPDFCtor){
      alert('No se cargó la librería de PDF (jsPDF).\nSi persiste, puede ser bloqueo del CDN por red/extensión.');
      return;
    }

    // ⚠️ Importante: NO usar `typeof doc` antes del `const doc` (TDZ) porque rompe la generación de PDF.
    const doc = new jsPDFCtor({ orientation: 'landscape' });

    doc.setFontSize(14);
    doc.text('Recepción de Pedidos', 14, 14);

    const isEnvio = (typeof currentMode !== 'undefined' && currentMode === 'Envío');
    const whoLabel = (isEnvio ? 'Enviado por' : 'Recibido por');
    const whoValue = els.rec.value || els.recibidoTop.textContent;

    doc.setFontSize(10);
    doc.text(`Generado: ${new Date().toLocaleString('es-CL')} | ${whoLabel}: ${whoValue}`, 14, 20);

    if (isEnvio && ui.distEnvio && ui.distEnvio.value) {
      doc.setFont(undefined, 'bold');
      doc.text(`Distribuidora: ${ui.distEnvio.value}`, 14, 26);
      doc.setFont(undefined, 'normal');
    }

    let head, body, startY = isEnvio ? 32 : 26;

    if (isEnvio) {
      head = [[ '#','Nº\npedido','Vendedora','Nº\npaq' ]];
      body = rows.map((r,i)=>[ i+1, r.n, r.v, r.q ]);
    } else {
      head = [[ '#','Nº\npedido','Distribuidora','Vendedora','Nº\npaq','Firma distribuidora','Entregado por','Fecha\nentrega','R' ]];
      body = rows.map((r,i)=>[ i+1, r.n, shortDist(r.d), r.v, r.q, '', '', '', '' ]);
    }

    // Asegurar autoTable
    if(typeof doc.autoTable !== 'function'){
      alert('No se cargó la librería de tablas (autoTable).\nPrueba: recargar con Ctrl+F5.');
      return;
    }

    doc.autoTable({
      head, body, startY,
      theme:'grid',
      styles:{ fontSize:9, cellPadding:3, lineColor:[0,0,0], lineWidth:0.2, halign:'center', valign:'middle' },
      headStyles:{ fillColor:[19,111,99], textColor:255, halign:'center' },
      alternateRowStyles:{ fillColor:[243,249,247] },
      columnStyles: isEnvio
        ? { 0:{cellWidth:12}, 1:{cellWidth:40}, 2:{cellWidth:160}, 3:{cellWidth:25} }
        : { 0:{cellWidth:10}, 1:{cellWidth:22}, 2:{cellWidth:44}, 3:{cellWidth:68}, 4:{cellWidth:14}, 8:{cellWidth:10} },
      tableWidth: 'auto',
      margin: { left: 14, right: 14 },
      didDrawCell: isEnvio ? undefined : function(data){
        if(data.section==='body' && data.column.index===8){
          const size = 5;
          const x = data.cell.x + (data.cell.width - size)/2;
          const y = data.cell.y + (data.cell.height - size)/2;
          doc.setLineWidth(0.4);
          doc.rect(x, y, size, size);
        }
      }
    });

    if (isEnvio) {
      let y = (doc.lastAutoTable && doc.lastAutoTable.finalY) ? doc.lastAutoTable.finalY + 12 : 40;

      doc.setFontSize(11);
      doc.text('Confirmación de recepción:', 14, y); y += 8;

      doc.setFontSize(10);
      const leyenda = 'Declaro haber recibido conforme los paquetes detallados en este informe.';
      doc.text(doc.splitTextToSize(leyenda, 250), 14, y);
      y += 18;

      doc.line(14, y, 95, y);
      doc.text('Firma y Rut de la distribuidora', 14, y + 5);

      doc.line(120, y, 190, y);
      doc.text('Fecha', 120, y + 5);
    }

    doc.save('recepcion_pedidos.pdf');

    // En modo Envío, marcar enviados (no bloquea el PDF)
    if (isEnvio) {
      try {
        const ids = rows.map(r=>r.id).filter(Boolean);
        if (ids.length) {
          const payload = { action: 'markSent', ids, envioId: `ENV-${new Date().toISOString().slice(0,10)}` };
          fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type':'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
          });
        }
      } catch (e) {
        alert('PDF generado, pero no se pudo marcar como ENVIADO en Sheets.');
      }
    }

    rows = [];
    paint();

  }catch(err){
  console.error('[toPDF]', err);
  alert('Ocurrió un error al generar el PDF.\nAbre la consola (F12) y revisamos el detalle si se repite.');
}


  // ===== Listeners =====
  els.btnSave.onclick=save;
  els.btnClear.onclick=()=>{ if(confirm('¿Eliminar todo?')){ rows=[]; paint(); } };
  els.btnPdf.onclick=toPDF;

  // Mantener el nombre seleccionado arriba (sirve sobre todo para Envío)
  els.rec.addEventListener('change',()=>{
    els.recibidoTop.textContent = els.rec.value || '(selecciona abajo)';
  });

  // Navegación con Enter
  els.numero.addEventListener('keypress',function(e){ if(e.key==='Enter'){ e.preventDefault(); (currentMode==='Envío'? els.vend : els.dist).focus(); }});
  els.dist.addEventListener('keypress',function(e){ if(e.key==='Enter'){ e.preventDefault(); els.vend.focus(); }});
  els.vend.addEventListener('keypress',function(e){ if(e.key==='Enter'){ e.preventDefault(); els.rec.focus(); }});
  els.rec.addEventListener('keypress',function(e){ if(e.key==='Enter'){ e.preventDefault(); els.paq.focus(); }});
  els.paq.addEventListener('keypress',function(e){ if(e.key==='Enter'){ e.preventDefault(); els.btnSave.focus(); }});

  window.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
