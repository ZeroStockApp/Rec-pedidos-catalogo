<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recepción de Pedidos</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    html{color-scheme: light;}
    :root{
      --primary:#136f63; --ink:#111827; --bg:#f7f7f8; --card:#ffffff; --ring:#d1d5db; --muted:#6b7280; --radius:14px;
      color-scheme: light;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial; background:var(--bg); color:var(--ink); margin:0;}
    .container{max-width:980px; margin:32px auto; padding:0 16px}
    h1{font-size:clamp(22px,3vw,28px); margin:0 0 6px}
    .sub{color:#374151; margin:0 0 18px}
    .card{background:var(--card); border:1px solid var(--ring); border-radius:var(--radius); box-shadow:0 6px 24px rgba(0,0,0,.06)}
    .form{padding:18px}
    .row{display:grid; gap:14px; grid-template-columns:repeat(12,1fr)}
    .col-3{grid-column:span 3}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    label{display:block; font-size:13px; color:var(--muted); margin:2px 0 6px}
    input[type=text], input[type=number], select{width:100%; padding:10px 12px; border:1px solid var(--ring); border-radius:10px; background:#fff; font-size:14px}
    select{background:#fff; color:#111827;}
    select{color-scheme: light; -webkit-text-fill-color:#111827;}
    .actions{display:flex; gap:10px; flex-wrap:wrap; padding:16px; border-top:1px solid var(--ring); background:linear-gradient(#fff,#fbfbfb)}
    button{appearance:none; border:0; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; font-size:14px}
    .primary{background:var(--primary); color:#fff}
    .ghost{background:#1e8f7f; color:#fff;}
    .ghost:hover{background:#136f63;}
    .danger{background:#fee2e2; color:#7f1d1d}

    .table-card{margin-top:16px; border-radius:14px; overflow:hidden; border:1px solid #000;}
    table{border-collapse:collapse; width:100%; font-size:14px;}
    th,td{padding:6px 8px; overflow:hidden; text-overflow:ellipsis;}
    table, thead th, tbody td {border:1px solid #000;}
    thead th{background:#136f63; color:#fff; text-align:center;}
    tbody td.num{text-align:center}

    #btnPdf{background:#DB2777;color:#fff}
    #btnPdf:hover{background:#BE185D}

    .btn-edit{background:#e0f2fe; color:#0369a1; border-radius:6px; padding:4px 8px; margin:0 3px}
    .btn-del{background:#fee2e2; color:#b91c1c; border-radius:6px; padding:4px 8px; margin:0 3px}
    td.actions-cell{display:flex; justify-content:center; align-items:center;}
    td.actions-cell button{flex:1; text-align:center;}
    th:last-child, td.actions-cell{width:150px;}

    /* Ajuste final de la tabla en pantalla */
    #tbl tbody tr { height: auto !important; }
    #tbl tbody td { padding: 2px 6px !important; line-height: 1.1 !important; }
    #tbl tbody td.actions-cell { padding-top: 0 !important; padding-bottom: 0 !important; }
    #tbl tbody td.actions-cell .btn-edit,
    #tbl tbody td.actions-cell .btn-del { padding: 2px 6px !important; font-size: 12px !important; }

    /* Filas alternadas tipo Excel (pantalla) */
    #tbl tbody tr:nth-child(odd) { background-color: #f3f9f7 !important; }
    #tbl tbody tr:nth-child(even) { background-color: #ffffff !important; }

    /* Zebra en pantalla */
    .table-card table tbody tr:nth-child(odd) { background-color: #f3f9f7; }
    .table-card table tbody tr:nth-child(even) { background-color: #ffffff; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Recepción de Pedidos</h1>
    <p class="sub"><span id="gen"></span> | Recibido por: <b id="recibidoTop">(selecciona abajo)</b></p>

    <section class="card form">
      <h2 style="margin:0 0 10px; font-size:18px">Nuevo pedido</h2>

      <!-- Selector de modo (no modifica estilos existentes) -->
      <div class="row">
  <div class="col-12">
    <label>Tipo de registro</label>
    <div style="display:flex;align-items:center;gap:14px">
      <label><input id="modeRecep" type="radio" name="mode" value="Recepción" checked> Recepción</label>
      <label><input id="modeEnvio" type="radio" name="mode" value="Envío"> Envío</label>
    </div>
  </div>
</div>

      <!-- En modo Envío, se elige una sola vez la distribuidora -->
      <div id="envioBlock" class="row" style="display:none;">
        <div class="col-6">
          <label for="distEnvio">Distribuidora (modo Envío — se usa para todo)</label>
          <select id="distEnvio"></select>
        </div>
        <div class="col-3">
          <label for="fechaDesde">Desde</label>
          <input id="fechaDesde" type="date" />
        </div>
        <div class="col-3">
          <label for="fechaHasta">Hasta</label>
          <input id="fechaHasta" type="date" />
        </div>
        <div class="col-12" style="display:flex;gap:10px;align-items:flex-end;">
          <button class="primary" type="button" id="btnCargar" style="margin-top:6px;">Cargar pedidos pendientes</button>
          <span id="envioStatus" style="color:#6b7280;font-size:13px;"></span>
        </div>
      </div>

      <div class="row">
        <div class="col-3">
          <label for="numero">Nº pedido</label>
          <input id="numero" type="text" placeholder="Ej: P00001" />
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <label for="dist">Distribuidora</label>
          <select id="dist"></select>
        </div>
        <div class="col-6">
          <label for="vend">Vendedora / Consultora</label>
          <input id="vend" type="text" placeholder="Escribe el nombre completo" />
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <label for="rec">Recibido por</label>
          <select id="rec"></select>
        </div>
        <div class="col-3">
          <label for="paq">Nº de paquetes</label>
          <input id="paq" type="number" min="1" value="1" />
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="btnSave">Guardar pedido</button>
        <button class="ghost" id="btnPdf">Descargar PDF</button>
        <button class="danger" id="btnClear">Borrar todo</button>
      </div>
    </section>

    <div class="card table-card">
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>Nº<br>pedido</th>
            <th>Distribuidora</th>
            <th>Vendedora</th>
            <th>Nº<br>paq</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
// Distribuidoras (una por línea, comillas y comas correctas)
const DIST = [
  "Ana Elizabeth Krause Seron",
  "Carla Valentina Gallardo Miranda",
  "Claudia Edith Perez Cobo",
  "Darly Solange Cartes Placencia",
  "Denisse Paulina Castro Almonacid",
  "Elizabeth Nathalie Torrez Pena",
  "Francheska Gisley Vasquez Perez",
  "Fredna Odette Cardenas Yanez",
  "Jeniffer Alejandra Gallardo Palma",
  "Katherine Naara Sanhueza Cid",
  "Madeleine Escobar Riquelme",
  "Maria Jose Urrea Leal",
  "Mixsi Urania Carrasco Garnica",
  "Monica Andrea Oliva Quiroga",
  "Nayareth Yetsennia Sanhueza Valdez",
  "Paola Lorena Contreras Alarcon",
  "Rocio Pilar Guerrero Barria",
  "Patricia Alejandra Marcos Villalobos",
  "Solange Stefani Soto Huala",
  "Valentina Beatriz Cancino Maldonado",
  "Viviana Erika Soto Oliva",
  "Yanira Constanza Espinoza Benavides"
];

// Recibido por (orden que usabas)
const REC = [
  "Harumi Araujo",
  "Mireya Venegas",
  "Daniel Parada",
  "Claudia Cuero",
  "Maria Alvarez",
  "Juan Fernandez",
];

// ===============================
// ✅ Conexión a Google Apps Script
// ===============================
// URL de tu Web App (Apps Script)
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxuQsp71wM3ZMq89B5KDlM4jZlPYQaz24oqPGA6s9IC_3VWzFcCZ5ZvA6kGSx889vK00g/exec";

// Tag de version para saber si GitHub esta sirviendo el HTML nuevo
const BUILD_TAG = "save-addOne-numPedido-v4";

// Acciones que vamos a intentar para guardar.
// (Esto hace que el front sea resistente si el backend usa otro nombre de acción.)
// Accion fija para guardar (segun tu backend): addOne
// (Dejamos de probar multiples acciones para evitar confusiones con el ultimo intento.)
const SAVE_ACTION = "addOne";


async function fetchJsonSafe(res){
  const text = await res.text();
  try { return { ok: res.ok, json: JSON.parse(text), text }; }
  catch { return { ok: res.ok, json: null, text }; }
}

function looksLikeSuccess(payload){
  if(!payload) return false;
  if(typeof payload === 'string'){
    const t = payload.trim().toLowerCase();
    return t === 'ok' || t === 'success' || t.includes('guardado') || t.includes('saved');
  }
  if(typeof payload === 'object'){
    if(payload.ok === true || payload.success === true) return true;
    if(typeof payload.status === 'string' && payload.status.toLowerCase() === 'ok') return true;
    if(typeof payload.result === 'string' && payload.result.toLowerCase() === 'ok') return true;
  }
  return false;
}

async function postToBackend(action, data){
  // ✅ Tu backend hace JSON.parse del body, pero tambien valida action (addOne / markSent).
  // Para cumplir ambos: enviamos action en la URL y el body como JSON.
  // Usamos Content-Type text/plain para evitar el preflight CORS tipico de Apps Script.
  // En algunos Apps Script, los campos se leen desde e.parameter (query/form) y no desde el body.
  // Por eso enviamos TODO tambien como query params, ademas del body JSON.
  const qs = new URLSearchParams();
  qs.set('action', action);
  Object.entries(data).forEach(([k,v]) => qs.set(k, String(v ?? '')));

  const url = `${APPS_SCRIPT_URL}?${qs.toString()}`;

  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
    body: JSON.stringify(data)
  });

  const out = await fetchJsonSafe(res);
  const payload = out.json ?? out.text;
  if(looksLikeSuccess(payload)) return { ok:true, payload };
  return { ok:false, payload };
}

async function savePedidoToSheet(data){
  // Guardar pedido nuevo
  return await postToBackend(SAVE_ACTION, data);
}


  // ===== Referencias UI =====
  const els={
    gen:document.getElementById('gen'),
    recibidoTop:document.getElementById('recibidoTop'),
    numero:document.getElementById('numero'),
    dist:document.getElementById('dist'),
    vend:document.getElementById('vend'),
    rec:document.getElementById('rec'),
    paq:document.getElementById('paq'),
    tbody:document.querySelector('#tbl tbody'),
    btnSave:document.getElementById('btnSave'),
    btnPdf:document.getElementById('btnPdf'),
    btnClear:document.getElementById('btnClear')
  };
  const ui={
    modeRecep:document.getElementById('modeRecep'),
    modeEnvio:document.getElementById('modeEnvio'),
    envioBlock:document.getElementById('envioBlock'),
    distEnvio:document.getElementById('distEnvio'),
    fechaDesde:document.getElementById('fechaDesde'),
    fechaHasta:document.getElementById('fechaHasta'),
    btnCargar:document.getElementById('btnCargar'),
    envioStatus:document.getElementById('envioStatus')
  };

  let currentMode='Recepción';
  let rows=[]; let editIndex=-1;

  function init(){
    els.gen.textContent=`Generado: ${new Date().toLocaleString('es-CL')}`;
    loadSelect(els.dist,DIST); loadSelect(els.rec,REC); loadSelect(ui.distEnvio,DIST);
    setMode('Recepción');
  }
  function loadSelect(sel,list){sel.innerHTML='<option value="" disabled selected>Selecciona...</option>'+list.map(x=>`<option>${x}</option>`).join('');}
  function shortDist(full){const p=full.trim().split(/\s+/); if(p.length>=4)return `${p[0]} ${p[2]}`; if(p.length===3)return `${p[0]} ${p[1]}`; if(p.length===2)return `${p[0]} ${p[1]}`; return full;}

  // ===== Selector de modo =====
  function clearTableAndForm(){ rows=[]; paint(); els.numero.value=''; els.vend.value=''; els.paq.value=1; els.dist.selectedIndex=0; }
  function setMode(mode){
    currentMode=mode;
    if(mode==='Envío'){
      ui.envioBlock.style.display='grid';
      els.dist.disabled=true;
      els.dist.value = ui.distEnvio.value || '';
    }else{
      ui.envioBlock.style.display='none';
      els.dist.disabled=false;
      els.dist.selectedIndex=0; // vuelve al estado original
    }
    // Requisito: al cambiar de modo, limpiar la tabla
    clearTableAndForm();
  }
  ui.modeRecep.addEventListener('change',()=>setMode('Recepción'));
  ui.modeEnvio.addEventListener('change',()=>setMode('Envío'));
  ui.distEnvio.addEventListener('change',()=>{ if(currentMode==='Envío'){ els.dist.value=ui.distEnvio.value||''; }});

  // ===== Envío (FASE 1): UI estable y sin errores =====
// Nota: primero aseguramos que el modo Envío no rompa los selects.
// En la siguiente fase conectamos la carga de pendientes.

function setEnvioStatus(msg){ if(ui.envioStatus) ui.envioStatus.textContent = msg || ''; }

async function cargarPendientesEnvio(){
  if(currentMode!=='Envío') return;

  const dist = (ui.distEnvio && ui.distEnvio.value) ? ui.distEnvio.value : '';
  if(!dist){ const msg = "No se pudo cargar pedidos pendientes (backend sin accion de consulta)."+
// (nota interna removida: antes aqui habia un texto suelto que rompia el JS)
