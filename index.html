<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recepci√≥n de Pedidos</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    :root{
      --primary:#136f63; --ink:#111827; --bg:#f7f7f8; --card:#ffffff; --ring:#d1d5db; --muted:#6b7280; --radius:14px;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial; background:var(--bg); color:var(--ink); margin:0;}
    .container{max-width:980px; margin:32px auto; padding:0 16px}
    h1{font-size:clamp(22px,3vw,28px); margin:0 0 6px}
    .sub{color:#374151; margin:0 0 18px}
    .card{background:var(--card); border:1px solid var(--ring); border-radius:var(--radius); box-shadow:0 6px 24px rgba(0,0,0,.06)}
    .form{padding:18px}
    .row{display:grid; gap:14px; grid-template-columns:repeat(12,1fr)}
    .col-3{grid-column:span 3}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    label{display:block; font-size:13px; color:var(--muted); margin:2px 0 6px}
    input[type=text], input[type=number], select{width:100%; padding:10px 12px; border:1px solid var(--ring); border-radius:10px; background:#fff; font-size:14px}
    select, option{background:#fff !important; color:#111827 !important}
    .actions{display:flex; gap:10px; flex-wrap:wrap; padding:16px; border-top:1px solid var(--ring); background:linear-gradient(#fff,#fbfbfb)}
    button{appearance:none; border:0; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; font-size:14px}
    .primary{background:var(--primary); color:#fff}
    .ghost{background:#1e8f7f; color:#fff;}
    .ghost:hover{background:#136f63;}
    .danger{background:#fee2e2; color:#7f1d1d}

    .table-card{margin-top:16px; border-radius:14px; overflow:hidden; border:1px solid #000;}
    table{border-collapse:collapse; width:100%; font-size:14px;}
    th,td{padding:6px 8px; overflow:hidden; text-overflow:ellipsis;}
    table, thead th, tbody td {border:1px solid #000;}
    thead th{background:#136f63; color:#fff; text-align:center;}
    tbody td.num{text-align:center}

    #btnPdf{background:#DB2777;color:#fff}
    #btnPdf:hover{background:#BE185D}

    .btn-edit{background:#e0f2fe; color:#0369a1; border-radius:6px; padding:4px 8px; margin:0 3px}
    .btn-del{background:#fee2e2; color:#b91c1c; border-radius:6px; padding:4px 8px; margin:0 3px}
    td.actions-cell{display:flex; justify-content:center; align-items:center;}
    td.actions-cell button{flex:1; text-align:center;}
    th:last-child, td.actions-cell{width:150px;}

    /* üéØ Ajuste final de la tabla en pantalla */
    #tbl tbody tr { height: auto !important; }
    #tbl tbody td { padding: 2px 6px !important; line-height: 1.1 !important; }
    #tbl tbody td.actions-cell { padding-top: 0 !important; padding-bottom: 0 !important; }
    #tbl tbody td.actions-cell .btn-edit,
    #tbl tbody td.actions-cell .btn-del { padding: 2px 6px !important; font-size: 12px !important; }

    /* üå∏ Filas alternadas tipo Excel (pantalla) */
    #tbl tbody tr:nth-child(odd) { background-color: #f3f9f7 !important; }
    #tbl tbody tr:nth-child(even) { background-color: #ffffff !important; }

    /* Zebra en pantalla */
    .table-card table tbody tr:nth-child(odd) { background-color: #f3f9f7; }
    .table-card table tbody tr:nth-child(even) { background-color: #ffffff; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Recepci√≥n de Pedidos</h1>
    <p class="sub"><span id="gen"></span> | Recibido por: <b id="recibidoTop">(selecciona abajo)</b></p>

    <section class="card form">
      <h2 style="margin:0 0 10px; font-size:18px">Nuevo pedido</h2>

      <!-- Selector de modo (no modifica estilos existentes) -->
      <div class="row">
  <div class="col-12">
    <label>Tipo de registro</label>
    <div style="display:flex;align-items:center;gap:14px">
      <label><input id="modeRecep" type="radio" name="mode" value="Recepci√≥n" checked> Recepci√≥n</label>
      <label><input id="modeEnvio" type="radio" name="mode" value="Env√≠o"> Env√≠o</label>
    </div>
  </div>
</div>

      <!-- En modo Env√≠o, se elige una sola vez la distribuidora -->
      <div id="envioBlock" class="row" style="display:none;">
        <div class="col-6">
          <label for="distEnvio">Distribuidora (modo Env√≠o ‚Äî se usa para todo)</label>
          <select id="distEnvio"></select>
        </div>
      </div>

      <div class="row">
        <div class="col-3">
          <label for="numero">N¬∫ pedido</label>
          <input id="numero" type="text" placeholder="Ej: P00001" />
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <label for="dist">Distribuidora</label>
          <select id="dist"></select>
        </div>
        <div class="col-6">
          <label for="vend">Vendedora / Consultora</label>
          <input id="vend" type="text" placeholder="Escribe el nombre completo" />
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <label for="rec">Recibido por</label>
          <select id="rec"></select>
        </div>
        <div class="col-3">
          <label for="paq">N¬∫ de paquetes</label>
          <input id="paq" type="number" min="1" value="1" />
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="btnSave">Guardar pedido</button>
        <button class="ghost" id="btnPdf">Descargar PDF</button>
        <button class="danger" id="btnClear">Borrar todo</button>
      </div>
    </section>

    <div class="card table-card">
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>N¬∫<br>pedido</th>
            <th>Distribuidora</th>
            <th>Vendedora</th>
            <th>N¬∫<br>paq</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
// Distribuidoras (una por l√≠nea, comillas y comas correctas)
const DIST = [
  "Ana Elizabeth Krause Seron",
  "Carla Valentina Gallardo Miranda",
  "Claudia Edith Perez Cobo",
  "Darly Solange Cartes Placencia",
  "Denisse Paulina Castro Almonacid",
  "Elizabeth Nathalie Torrez Pena",
  "Francheska Gisley Vasquez Perez",
  "Fredna Odette Cardenas Yanez",
  "Jeniffer Alejandra Gallardo Palma",
  "Katherine Naara Sanhueza Cid",
  "Madeleine Escobar Riquelme",
  "Maria Jose Urrea Leal",
  "Mixsi Urania Carrasco Garnica",
  "Monica Andrea Oliva Quiroga",
  "Nayareth Yetsennia Sanhueza Valdez",
  "Paola Lorena Contreras Alarcon",
  "Rocio Pilar Guerrero Barria",
  "Patricia Alejandra Marcos Villalobos",
  "Solange Stefani Soto Huala",
  "Valentina Beatriz Cancino Maldonado",
  "Viviana Erika Soto Oliva",
  "Yanira Constanza Espinoza Benavides"
];

// Recibido por (orden que usabas)
const REC = [
  "Harumi Araujo",
  "Mireya Venegas",
  "IDaniel Parada",
  "Claudia Cuero",
  "Maria Alvarez",
  "Juan Fernandez",
];

// ===============================
// ‚úÖ Conexi√≥n a Google Apps Script
// ===============================
// URL de tu Web App (Apps Script)
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxuQsp71wM3ZMq89B5KDlM4jZlPYQaz24oqPGA6s9IC_3VWzFcCZ5ZvA6kGSx889vK00g/exec";

// Acciones que vamos a intentar para guardar.
// (Esto hace que el front sea resistente si el backend usa otro nombre de acci√≥n.)
const SAVE_ACTION_CANDIDATES = [
  "savePedido",
  "guardarPedido",
  "save",
  "addPedido",
  "createPedido"
];

async function fetchJsonSafe(res){
  const text = await res.text();
  try { return { ok: res.ok, json: JSON.parse(text), text }; }
  catch { return { ok: res.ok, json: null, text }; }
}

function looksLikeSuccess(payload){
  if(!payload) return false;
  if(typeof payload === 'string'){
    const t = payload.trim().toLowerCase();
    return t === 'ok' || t === 'success' || t.includes('guardado') || t.includes('saved');
  }
  if(typeof payload === 'object'){
    if(payload.ok === true || payload.success === true) return true;
    if(typeof payload.status === 'string' && payload.status.toLowerCase() === 'ok') return true;
    if(typeof payload.result === 'string' && payload.result.toLowerCase() === 'ok') return true;
  }
  return false;
}

async function postToBackend(action, data){
  // 1) Intento JSON
  try{
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action, ...data })
    });
    const out = await fetchJsonSafe(res);
    const payload = out.json ?? out.text;
    if(looksLikeSuccess(payload)) return { ok:true, payload };
    // si respondi√≥ pero no fue √©xito, devolvemos el contenido para diagn√≥stico
    return { ok:false, payload };
  }catch(err){
    // 2) Fallback: form-urlencoded (muchos GAS lo leen as√≠)
    const form = new URLSearchParams();
    form.set('action', action);
    Object.entries(data).forEach(([k,v])=>form.set(k, String(v ?? '')));
    const res2 = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: form.toString()
    });
    const out2 = await fetchJsonSafe(res2);
    const payload2 = out2.json ?? out2.text;
    if(looksLikeSuccess(payload2)) return { ok:true, payload: payload2 };
    return { ok:false, payload: payload2, error: String(err) };
  }
}

async function savePedidoToSheet(data){
  // Probamos distintas acciones hasta que una funcione.
  // Si tu backend usa un nombre distinto, aqu√≠ lo ajustamos en 1 sola l√≠nea.
  let last;
  for(const action of SAVE_ACTION_CANDIDATES){
    const r = await postToBackend(action, data);
    last = r;
    if(r.ok) return r;
  }
  return last || { ok:false, payload:'No hubo respuesta' };
}

  // ===== Referencias UI =====
  const els={
    gen:document.getElementById('gen'),
    recibidoTop:document.getElementById('recibidoTop'),
    numero:document.getElementById('numero'),
    dist:document.getElementById('dist'),
    vend:document.getElementById('vend'),
    rec:document.getElementById('rec'),
    paq:document.getElementById('paq'),
    tbody:document.querySelector('#tbl tbody'),
    btnSave:document.getElementById('btnSave'),
    btnPdf:document.getElementById('btnPdf'),
    btnClear:document.getElementById('btnClear')
  };
  const ui={
    modeRecep:document.getElementById('modeRecep'),
    modeEnvio:document.getElementById('modeEnvio'),
    envioBlock:document.getElementById('envioBlock'),
    distEnvio:document.getElementById('distEnvio')
  };

  let currentMode='Recepci√≥n';
  let rows=[]; let editIndex=-1;

  function init(){
    els.gen.textContent=`Generado: ${new Date().toLocaleString('es-CL')}`;
    loadSelect(els.dist,DIST); loadSelect(els.rec,REC); loadSelect(ui.distEnvio,DIST);
    setMode('Recepci√≥n');
  }
  function loadSelect(sel,list){sel.innerHTML='<option value="" disabled selected>Selecciona‚Ä¶</option>'+list.map(x=>`<option>${x}</option>`).join('');}
  function shortDist(full){const p=full.trim().split(/\s+/); if(p.length>=4)return `${p[0]} ${p[2]}`; if(p.length===3)return `${p[0]} ${p[1]}`; if(p.length===2)return `${p[0]} ${p[1]}`; return full;}

  // ===== Selector de modo =====
  function clearTableAndForm(){ rows=[]; paint(); els.numero.value=''; els.vend.value=''; els.paq.value=1; els.dist.selectedIndex=0; }
  function setMode(mode){
    currentMode=mode;
    if(mode==='Env√≠o'){
      ui.envioBlock.style.display='grid';
      els.dist.disabled=true;
      els.dist.value = ui.distEnvio.value || '';
    }else{
      ui.envioBlock.style.display='none';
      els.dist.disabled=false;
      els.dist.selectedIndex=0; // vuelve al estado original
    }
    // ‚úÖ Requisito: al cambiar de modo, limpiar la tabla
    clearTableAndForm();
  }
  ui.modeRecep.addEventListener('change',()=>setMode('Recepci√≥n'));
  ui.modeEnvio.addEventListener('change',()=>setMode('Env√≠o'));
  ui.distEnvio.addEventListener('change',()=>{ if(currentMode==='Env√≠o'){ els.dist.value=ui.distEnvio.value||''; }});

  // ===== CRUD =====
  async function save(){
    const distValue=(currentMode==='Env√≠o')?ui.distEnvio.value:els.dist.value;
    if(!els.numero.value||!distValue||!els.vend.value||!els.rec.value||!els.paq.value){alert('Completa todos los campos');return;}

    // Datos base (los que ya manejas)
    const data={
      n:els.numero.value.trim(),
      d:distValue,
      v:els.vend.value.trim(),
      q:Number(els.paq.value)
    };

    // üîó Datos para el Google Sheet (coinciden con tu estructura: FECHA, PEDIDO, DISTRIBUIDORA, VENDEDORA, PAQUETES, ENVIADO)
    // Nota: ENVIADO lo dejamos en "NO" por defecto. Luego, en el flujo de Env√≠o lo marcaremos como "SI".
    const payload={
      id: (editIndex>-1 && rows[editIndex] && rows[editIndex].id) ? rows[editIndex].id : '',
      fecha: new Date().toISOString(),
      pedido: data.n,
      distribuidora: data.d,
      vendedora: data.v,
      paquetes: data.q,
      recibidoPor: els.rec.value,
      enviado: 'NO',
      modo: currentMode
    };

    // UX: deshabilitamos el bot√≥n mientras guarda
    els.btnSave.disabled = true;
    els.btnSave.textContent = 'Guardando‚Ä¶';

    const result = await savePedidoToSheet(payload);

    els.btnSave.disabled = false;
    els.btnSave.textContent = 'Guardar pedido';

    if(!result || !result.ok){
      // Mostramos lo que respondi√≥ el backend para que lo ajustemos sin adivinar
      const msg = (result && result.payload) ? (typeof result.payload === 'string' ? result.payload : JSON.stringify(result.payload)) : 'Error desconocido';
      alert('No se pudo guardar en Google Sheets.

Detalle:
' + msg);
      return;
    }

    // ‚úÖ Si el backend guard√≥ OK, mantenemos tu comportamiento actual en pantalla
    if(editIndex>-1){ rows[editIndex]=data; editIndex=-1; } else { rows.push(data); }
    els.recibidoTop.textContent=els.rec.value;
    els.numero.value=''; els.vend.value=''; els.paq.value=1; if(currentMode==='Recepci√≥n'){ els.dist.selectedIndex=0; }
    paint();
    els.numero.focus();
  }

  function paint(){
    els.tbody.innerHTML=rows.map((r,i)=>`<tr>
      <td class="num">${i+1}</td>
      <td>${r.n}</td>
      <td>${shortDist(r.d)}</td>
      <td>${r.v}</td>
      <td class="num">${r.q}</td>
      <td class="actions-cell">
        <button class="btn-edit" onclick="editRow(${i})">‚úèÔ∏è Editar</button>
        <button class="btn-del" onclick="delRow(${i})">üóëÔ∏è Eliminar</button>
      </td>
    </tr>`).join('');
  }

  window.editRow=function(i){ const r=rows[i]; els.numero.value=r.n; els.dist.value=r.d; els.vend.value=r.v; els.paq.value=r.q; editIndex=i; if(currentMode==='Env√≠o'){ ui.distEnvio.value=r.d; } };
  window.delRow=function(i){ if(confirm('¬øEliminar este pedido?')){ rows.splice(i,1); paint(); } };

 function toPDF(){
  if(rows.length===0){ alert('No hay registros'); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'landscape' });

  // Encabezado
  doc.setFontSize(14);
  doc.text('Recepci√≥n de Pedidos', 14, 14);
  doc.setFontSize(10);
  doc.text(`Generado: ${new Date().toLocaleString('es-CL')} | Recibido por: ${els.recibidoTop.textContent}`, 14, 20);

  const isEnvio = (typeof currentMode !== 'undefined' && currentMode === 'Env√≠o');

  // Si es Env√≠o, muestra una sola vez la distribuidora en el encabezado
  if (isEnvio && ui.distEnvio && ui.distEnvio.value) {
    doc.setFont(undefined, 'bold');
    doc.text(`Distribuidora: ${ui.distEnvio.value}`, 14, 26);
    doc.setFont(undefined, 'normal'); // volver a normal para el resto
  }

  // ==== Tabla ====
  let head, body, startY = isEnvio ? 32 : 26;

  if (isEnvio) {
    // SIN columna Distribuidora, SIN columna de firma por fila
    head = [[ '#','N¬∫\npedido','Vendedora','N¬∫\npaq' ]];
    body = rows.map((r,i)=>[ i+1, r.n, r.v, r.q ]);
  } else {
    // Recepci√≥n: todo como lo ten√≠as (con firma por fila, entregado por, etc.)
    head = [[ '#','N¬∫\npedido','Distribuidora','Vendedora','N¬∫\npaq','Firma distribuidora','Entregado por','Fecha\nentrega','R' ]];
    body = rows.map((r,i)=>[ i+1, r.n, shortDist(r.d), r.v, r.q, '', '', '', '' ]);
  }

  doc.autoTable({
    head, body, startY,
    theme:'grid',
    styles:{ fontSize:9, cellPadding:3, lineColor:[0,0,0], lineWidth:0.2, halign:'center', valign:'middle' },
    headStyles:{ fillColor:[19,111,99], textColor:255, halign:'center' },
    alternateRowStyles:{ fillColor:[243,249,247] },
    columnStyles: isEnvio
  // üü¢ Env√≠o: distribuimos el ancho para que la tabla llene la p√°gina
  ? { 
      0:{cellWidth:12},   // #
      1:{cellWidth:40},   // N¬∫ pedido
      2:{cellWidth:160},  // Vendedora (m√°s ancho)
      3:{cellWidth:25}    // N¬∫ paq
    }
  // Recepci√≥n: lo de siempre
  : { 
      0:{cellWidth:10}, 1:{cellWidth:22}, 2:{cellWidth:44},
      3:{cellWidth:68}, 4:{cellWidth:14}, 8:{cellWidth:10}
    },
    tableWidth: 'auto',
    margin: { left: 14, right: 14 },

    didDrawCell: isEnvio ? undefined : function(data){
      // Solo en Recepci√≥n dibuja la casilla de verificaci√≥n (columna R)
      if(data.section==='body' && data.column.index===8){
        const size = 5;
        const x = data.cell.x + (data.cell.width - size)/2;
        const y = data.cell.y + (data.cell.height - size)/2;
        doc.setLineWidth(0.4);
        doc.rect(x, y, size, size);
      }
    }
  });

  // ==== Bloque de firma √∫nico (solo para Env√≠o) ====
  if (isEnvio) {
    let y = (doc.lastAutoTable && doc.lastAutoTable.finalY) ? doc.lastAutoTable.finalY + 12 : 40;

    doc.setFontSize(11);
    doc.text('Confirmaci√≥n de recepci√≥n:', 14, y); y += 8;

    doc.setFontSize(10);
    const leyenda = 'Declaro haber recibido conforme los paquetes detallados en este informe.';
    doc.text(doc.splitTextToSize(leyenda, 250), 14, y); 
    y += 18;

    // L√≠nea para firma
    doc.line(14, y, 95, y); 
    doc.text('Firma y Rut de la distribuidora', 14, y + 5);

    // L√≠nea para fecha
    doc.line(120, y, 190, y);
    doc.text('Fecha', 120, y + 5);
  }

  doc.save('recepcion_pedidos.pdf');

  // Limpiar tabla despu√©s de generar el PDF (como acordamos)
  rows = [];
  paint();
}

  // ===== Listeners =====
  els.btnSave.onclick=save; 
  els.btnClear.onclick=()=>{ if(confirm('¬øEliminar todo?')){ rows=[]; paint(); } }; 
  els.btnPdf.onclick=toPDF;

  // Navegaci√≥n con Enter
  els.numero.addEventListener('keypress',function(e){ if(e.key==='Enter'){ e.preventDefault(); (currentMode==='Env√≠o'? els.vend : els.dist).focus(); }});
  els.dist.addEventListener('keypress',function(e){ if(e.key==='Enter'){ e.preventDefault(); els.vend.focus(); }});
  els.vend.addEventListener('keypress',function(e){ if(e.key==='Enter'){ e.preventDefault(); els.rec.focus(); }});
  els.rec.addEventListener('keypress',function(e){ if(e.key==='Enter'){ e.preventDefault(); els.paq.focus(); }});
  els.paq.addEventListener('keypress',function(e){ if(e.key==='Enter'){ e.preventDefault(); els.btnSave.focus(); }});

  // Init
  init();
})();
</script>
</body>
</html>
